#!/bin/bash
# Upsun Environment Configuration
# Dieses Script erstellt die DATABASE_URL aus den Upsun-Umgebungsvariablen

# Upsun stellt Relationship-Informationen über Umgebungsvariablen bereit
# Format: <RELATIONSHIP_NAME>_<PROPERTY> (uppercase, - wird zu _)
# Beispiel: POSTGRESDATABASE_HOST, POSTGRESDATABASE_PORT, etc.

# Prüfen ob wir auf Upsun/Platform.sh laufen
if [ -n "$PLATFORM_RELATIONSHIPS" ]; then
    # Upsun/Platform.sh Umgebung - Relationships parsen
    getRelationshipInfo() {
        RELATIONSHIP_NAME="$1"
        PROPERTY="$2"
        JQ_STR="to_entries[] | select(.key==\"$RELATIONSHIP_NAME\") | .value[].$PROPERTY"
        CMD="echo $PLATFORM_RELATIONSHIPS | base64 -d | jq -r '$JQ_STR'"
        eval $CMD
    }

    RELATIONSHIP="postgresdatabase"
    DB_DATABASE="main"

    DB_USERNAME=$(getRelationshipInfo "$RELATIONSHIP" 'username')
    DB_HOST=$(getRelationshipInfo "$RELATIONSHIP" 'host')
    DB_PASS=$(getRelationshipInfo "$RELATIONSHIP" 'password')
    DB_PORT=$(getRelationshipInfo "$RELATIONSHIP" 'port')

    export DATABASE_URL="postgresql://$DB_USERNAME:$DB_PASS@$DB_HOST:$DB_PORT/$DB_DATABASE"
fi

# Hinweis: Die DATABASE_URL kann auch direkt in den Upsun-Projekteinstellungen
# als Umgebungsvariable gesetzt werden, was die bevorzugte Methode ist.
